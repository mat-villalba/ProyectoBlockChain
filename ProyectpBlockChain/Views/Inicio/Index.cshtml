@* Ubicación: TPFInal-PWIII-Web/Views/Inicio/Index.cshtml *@@{
    ViewData["Title"] = "Home";
    var nombreUsuario = ViewData["NombreUsuario"] as string;
    var walletUsuario = ViewData["WalletUsuario"] as string;
}

<div class="text-center">
    <h1 class="display-4">¡Bienvenido, @nombreUsuario!</h1>
    <p class="lead">Estás en el lobby de "Aventura Interactiva con Blockchain".</p>
    <p class="text-muted small">Wallet: @walletUsuario</p>
</div>
<hr />

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Mensaje"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


<div class="container mt-4">
    <div class="row justify-content-center g-3">

        <!-- btn para Jugar (Crear Partida) -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">Jugar</h5>
                    <p class="card-text">Inicia una nueva aventura y sé el anfitrión de la partida. Otros podrán unirse a tu juego.</p>
                    <button id="btnCrearPartida" class="btn btn-primary btn-lg">Crear Nueva Partida</button>
                </div>
            </div>
        </div>

        <!-- btn para Ver Historial -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">Ver Historial</h5>
                    <p class="card-text">Revisa las aventuras pasadas y consulta el historial inmutable de decisiones en la Blockchain.</p>
                    <a asp-controller="Juego" asp-action="Historial" class="btn btn-outline-secondary btn-lg">Ver Historial de Partidas</a>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- (Opcional) Un modal para mostrar las partidas activas a las que unirse -->
<!-- aca iría la lógica para "UnirseAPartida" -->

@section Scripts {
    <script>
        // maneja la creación de la partida

        document.getElementById("btnCrearPartida").addEventListener("click", async () => {

            // obtenemos la wallet del Host (que inyectó el Controlador)
            const walletJugador = "@walletUsuario"; 

            if (!walletJugador) {
                alert("Error: No se pudo encontrar tu WalletAddress en la sesión. Por favor, vuelve a iniciar sesión.");
                window.location.href = "/Jugador/IniciarSesion"; // Redirigir al login
                return;
            }

            console.log("Creando partida para el host:", walletJugador);

            // llamar a JuegoController para crear la partida
            try {
                // (Usamos '@Url.Action' para generar la URL correcta)
                const response = await fetch('@Url.Action("CrearPartida", "Juego")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // (Falta el Token AntiForgery si tu POST lo requiere)
                    },
                    // Enviamos la wallet del host en el body
                    body: JSON.stringify(walletJugador) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Error al crear la partida.");
                }

                const data = await response.json(); // Esperamos { partidaId: 5 }

                // mando al usuario a la pantalla donde se decide el capitulo de la partida
                console.log("Partida creada con ID:", data.partidaId);
                window.location.href = `/Juego/Partida/${data.partidaId}`; // Redirige a /Juego/Partida/5

            } catch (error) {
                console.error("Error:", error);
                alert(error.message);
            }
        });
    </script>
}
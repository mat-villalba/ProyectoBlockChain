@{
    ViewData["Title"] = "Home";
    var nombreUsuario = Context.Session.GetString("UserName");
    var walletUsuario = Context.Session.GetString("UserWalletAddress");
}

<div class="cartel-inicio">

    <h1 class="display-4">¡Bienvenido a la Aventura con Blockchain!</h1>
    <div class="descripcion">
        <p class="lead">Conecta tu cuenta para comenzar esta aventura!</p>
    </div>
    <p class="alerta" id="alerta" disabled></p>


@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Mensaje"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<button id="connectWalletBtn">Conectar billetera</button>
<p id="walletAddress"></p>

<button id="startGameBtn">Comenzar juego</button>
<a asp-controller="Explorador" asp-action="VerVotos" id="votosRegistrados" class="link">Ver votos registrados en la blockchain </a>

</div>

@* 
<a asp-controller="Explorador" asp-action="VerPartidas">Ver partidas registradas en la blockchain </a> *@

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
    let userAddress = localStorage.getItem("userAddress");

    async function connectWallet() {
        if (typeof window.ethereum === "undefined") {
            alert("Necesitás tener MetaMask instalado para continuar.");
            return;
        }

        // verificar que no este conectada ya
        var conexionCuenta = localStorage.getItem("userAddress");

        if(conexionCuenta !== null){
            document.getElementById("alerta").innerText = "Cuenta ya vinculada."
            return;
        }

        try {
            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            const account = accounts[0];
            userAddress = account;

            // 2️⃣ Pedirle que firme un mensaje (esto siempre abre MetaMask)
            const message = `Iniciá sesión para jugar - ${new Date().toLocaleString()}`;
            const signature = await window.ethereum.request({
                method: "personal_sign",
                params: [message, account],
            });

            console.log("Firma generada:", signature);
            localStorage.setItem("userAddress", userAddress);

            document.getElementById("walletAddress").innerText = `Billetera conectada: ${userAddress}`;
            document.getElementById("startGameBtn").disabled = false;
            document.getElementById("connectWalletBtn").disabled = true;
            document.getElementById("alerta").innerText = "";

        } catch (error) {
            console.error("Error al conectar o firmar:", error);
            alert("No se pudo conectar la billetera.");
        }
    }

    document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);

    // 4️⃣ Si el usuario cambia o desconecta la cuenta
    if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
            if (accounts.length === 0) {
                userAddress = null;
                document.getElementById("alerta").innerText = "Billetera desconectada.";
            } else {
                userAddress = accounts[0];
                document.getElementById("walletAddress").innerText = `Billetera conectada: ${userAddress}`;
            }
        });
    }

    // 5️⃣ Al presionar "Comenzar juego"
    document.getElementById("startGameBtn").addEventListener("click", async () => {
        if (!userAddress) {
            document.getElementById("alerta").disabled = false;
            document.getElementById("alerta").innerText = "Primero conectá tu billetera para comenzar el juego.";
            return;
        }

        // Verificar que MetaMask sigue conectada
        const accounts = await window.ethereum.request({ method: "eth_accounts" });
        if (accounts.length === 0 || accounts[0] !== userAddress) {
            alert("Tu billetera se desconectó. Volvé a iniciar sesión.");
            return;
        }
        document.getElementById("alerta").innerText = "";
        // Redirigir al juego
        window.location.href = "/Juego/Jugar";
    });

    document.getElementById("votosRegistrados").addEventListener("click", async (e) => {
        if (!userAddress) {
            e.preventDefault();
            document.getElementById("alerta").disabled = false;
            document.getElementById("alerta").innerText = "Primero conectá tu billetera para ver los votos registrados.";
            return;
        }
    });
</script>
@using ProyectoBlockChain.Logica.Core
@model InicioPartidaDTO
@{
    ViewData["Title"] = "Votar historia";
    var nombreUsuario = Context.Session.GetString("UserName");
    var walletUsuario = Context.Session.GetString("UserWalletAddress");
}

<h2>Votar historia</h2>

<p>
    Partida: <strong>@Model?.PartidaId</strong> —
    Capítulo: <strong>@Model?.Capitulo?.Id</strong>
</p>

<p>Tiempo restante: <span id="timer" style="font-weight:bold;color:red"></span></p>

<div style="margin-top:20px;">
    <p>
        @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Descripcion)
                ? "Descripción del capitulo"
                : Model.Capitulo.Descripcion)
    </p>
</div>


<div style="margin-top:20px;">
    <button id="btn-op1">
        @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Opcion1)
                ? "Texto Opción 1"
                : Model.Capitulo.Opcion1)
    </button>

    <button id="btn-op2">
        @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Opcion2)
                ? "Texto Opción 2"
                : Model.Capitulo.Opcion2)
    </button>
</div>

<p id="status" style="margin-top:12px;color:green"></p>
<pre id="out" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:8px;"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    (async () => {

        const partidaId = @Model.PartidaId;
        const capituloId = @Model.Capitulo.Id;
        const finVotacion = new Date("@Model.FinVotacion.ToString("o")").getTime();

        const CONTRACT_ADDRESS = "@Model.ContractAddress";
        const CONTRACT_ABI = await fetch('/abi/Contrato.json').then(r => r.json());

        const timerEl = document.getElementById("timer");
        const statusEl = document.getElementById("status");
        const outEl = document.getElementById("out");

        function show(msg) { statusEl.innerText = msg; }
        function log(o) { outEl.innerText = JSON.stringify(o, null, 2); }

        // --- TEMPORIZADOR ---
        const interval = setInterval(() => {
            const now = Date.now();
            const diff = finVotacion - now;

                if (diff <= 0) {
                    timerEl.innerText = "⛔ Tiempo terminado";
                    clearInterval(interval);

                    document.getElementById("btn-op1").disabled = true;
                    document.getElementById("btn-op2").disabled = true;

                    return;
                }


            timerEl.innerText = Math.floor(diff / 1000) + " segundos";
        }, 500);

        // --- VOTAR ---
        async function ensureProvider() {
            if (!window.ethereum) {
                alert('MetaMask no detectado.');
                throw new Error('No MetaMask');
            }
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send('eth_requestAccounts', []);
            return provider;
        }

            async function vote(opcion) {
        try {
            const provider = await ensureProvider();
            const signer = provider.getSigner();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            show(`Votando opción ${opcion}...`);
            const tx = await contract.votar(partidaId, capituloId, opcion, { gasLimit: 300000 });

            show('Esperando confirmación...');
            await tx.wait();

            show("✅ Voto registrado en blockchain");

            const response = await fetch("/Jugar/RegistrarVotoEmitido", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    partidaId: partidaId,
                    capituloId: capituloId,
                    opcionElegida: opcion
                })
            });

            if (!response.ok) {
                show("⚠️ Voto en blockchain OK, pero error guardando en backend");
                return;
            }

            show("🎉 Voto procesado — avanzando...");
            window.location.reload(); // opcional: recargar capítulo

        } catch (err) {
            console.error(err);
            show("❌ Error al votar");
        }
    }


        document.getElementById("btn-op1").addEventListener("click", () => vote("Opcion1"));
        document.getElementById("btn-op2").addEventListener("click", () => vote("Opcion2"));


    })();
</script>

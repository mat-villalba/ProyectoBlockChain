@{
    ViewData["Title"] = "Votar historia";
    var partidaId = ViewBag.PartidaId ?? 1;
    var capituloId = ViewBag.CapituloId ?? 1;
}

<h2>Votar historia</h2>
<p>Partida: <strong>@partidaId</strong> — Capítulo: <strong>@capituloId</strong></p>

<div style="margin-top:20px;">
    <button id="btnA">Votar Opción A</button>
    <button id="btnB">Votar Opción B</button>
</div>

<p id="status" style="margin-top:12px;color:green"></p>
<pre id="out" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:8px;"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
(async () => {

    // el jugador vota desde el navegador usando MetaMask
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');
    const btnA = document.getElementById('btnA');
    const btnB = document.getElementById('btnB');

    // qué contrato conectarse y con qué datos
    const partidaId = @partidaId;
    const capituloId = @capituloId;
    const CONTRACT_ADDRESS = "@ViewBag.ContractAddress";
    const CONTRACT_ABI = await fetch('/abi/Contrato.json').then(r => r.json());

    function show(msg) { statusEl.innerText = msg; }
    function log(o) { outEl.innerText = JSON.stringify(o, null, 2); }

        // Comprueba que el usuario tenga MetaMask
        // Pide permiso para acceder a su cuenta
        // Devuelve un provider, que permite comunicarse con la blockchain desde el navegador.
    async function ensureProvider() {
        if (!window.ethereum) {
            alert('No se detectó MetaMask.');
            throw new Error('MetaMask no detectado');
        }
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        return provider;
    }

    // cada jugador firma y paga su propia transacción de voto
    async function vote(opcion) {
        try {
            const provider = await ensureProvider();
            const signer = provider.getSigner(); // cuenta del jugador
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            show(`Votando opción ${opcion}...`);
            const tx = await contract.votar(partidaId, capituloId, opcion, { gasLimit: 300000 });
            show('Esperando confirmación...');
            const receipt = await tx.wait();
            show('✅ Voto registrado en blockchain');
            log(receipt);
        } catch(err) {
            console.error(err);
            show('❌ Error al votar. Revisá la consola.');
        }
    }

    btnA.addEventListener('click', () => vote('A'));
    btnB.addEventListener('click', () => vote('B'));
})();
</script>
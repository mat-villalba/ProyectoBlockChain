@{
    ViewData["Title"] = "Probar firma (sin gas)";
    // Valores de ejemplo que podés pasar desde el controlador
    var partidaId = ViewBag.PartidaId ?? 1;
    var capituloId = ViewBag.CapituloId ?? 1;
}

<h2>Prueba de firma (sin enviar transacción)</h2>
<p>Partida: <strong></strong> — Capítulo: <strong></strong></p>

<div style="margin-top:20px;">
    <button id="btnA">Votar Opción A</button>
    <button id="btnB">Votar Opción B</button>
</div>

<p id="status" style="margin-top:12px;color:green"></p>
<pre id="out" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:8px;"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
    (async () => {
        const statusEl = document.getElementById('status');
        const outEl = document.getElementById('out');
        const btnA = document.getElementById('btnA');
        const btnB = document.getElementById('btnB');

        const partidaId = @partidaId;
        const capituloId = @capituloId;

        const CONTRACT_ADDRESS = "@ViewBag.ContractAddress";
        const CONTRACT_ABI = JSON.parse(`@Html.Raw(ViewBag.ContractAbi.Replace("`", "\\`"))`);

            console.log("✅ Dirección del contrato:", CONTRACT_ADDRESS);
            console.log("✅ ABI cargado:", CONTRACT_ABI);

        function show(msg) { statusEl.innerText = msg; }
        function log(o) { outEl.innerText = JSON.stringify(o, null, 2); }

        async function ensureProvider() {
            if (typeof window.ethereum === 'undefined') {
                alert('No se detectó MetaMask. Instalá la extensión para continuar.');
                throw new Error('No MetaMask');
            }

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send('eth_requestAccounts', []); // pide conexión si no está
            return provider;
        }
            console.log("Votando con:", {
        partidaId: Number(partidaId),
        capituloId: Number(capituloId),
        opcionElegida
    });

                async function vote(opcion) {
        try {
            show('Conectando a MetaMask...');
            const provider = await ensureProvider();
            const signer = provider.getSigner();
            const address = await signer.getAddress();

            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            const opcionElegida = opcion === 'A' ? "A" : "B";

            // 🔹 Log de depuración aquí, donde opcionElegida ya existe
            console.log("Votando con:", {
                partidaId: Number(partidaId),
                capituloId: Number(capituloId),
                opcionElegida
            });

            show(`Enviando transacción para votar "${opcion}"...`);
            const tx = await contract.votar(
                Number(partidaId),
                Number(capituloId),
                opcionElegida,
                { gasLimit: 300000 }
            );

            show('Transacción enviada, esperando confirmación...');
            const receipt = await tx.wait();
            show('✅ Voto registrado en blockchain');
            log(receipt);

        } catch (err) {
            console.error('Error al llamar al contrato:', err);
            show('❌ Ocurrió un error. Revisa la consola.');
        }
    }

    }


        // Escuchar botones
        btnA.addEventListener('click', () => vote('A'));
        btnB.addEventListener('click', () => vote('B'));
    })();
</script>

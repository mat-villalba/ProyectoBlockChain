@using ProyectoBlockChain.Logica.Core
@model InicioPartidaDTO
@{
    ViewData["Title"] = "Votar historia";
}

<div class="principal">

<h2>Votar historia</h2>

<p>
    Partida: <strong>@Model?.PartidaId</strong> —
    Capítulo: <strong>@Model?.Capitulo?.Id</strong>
</p>

<p>Tiempo restante: <span id="timer" style="font-weight:bold;color:red"></span></p>

<div class="contenedor-historia">

    @{
        var capId = Model?.Capitulo?.Id;
        var imgPath = capId != null ? $"/img/{capId}.jpeg" : null;
    }

    @if (!string.IsNullOrEmpty(imgPath))
    {
        <div class="contenedor-imagen">
            <img src="@imgPath"
                 alt="Imagen del capítulo @(capId)"
                 class="img-fluid"
                 onerror="this.style.display='none';" />
        </div>
    }

        <div class="contenedor-texto">
            <p>
                @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Descripcion)
                                ? "Descripción del capitulo"
                                : Model.Capitulo.Descripcion)
            </p>
        </div>

</div>


<div class="contenedor-opciones">
    <button id="btn-op1" data-next="@Model?.Capitulo?.IdOpcion1">
        @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Opcion1)
                ? "Texto Opción 1"
                : Model.Capitulo.Opcion1)
    </button>

    <button id="btn-op2" data-next="@Model?.Capitulo?.IdOpcion2">
        @(string.IsNullOrWhiteSpace(Model?.Capitulo?.Opcion2)
                ? "Texto Opción 2"
                : Model.Capitulo.Opcion2)
    </button>
</div>

</div>

<p id="status" style="margin-top:12px;color:green"></p>
@* <pre id="out" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:8px;"></pre> *@

<button id="btn-finalizar" disabled>
    Finalizar votación
</button>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    (async () => {

        const partidaId = @Model.PartidaId;
        const capituloId = @Model.Capitulo.Id;
        const finVotacion = new Date("@Model.FinVotacion.ToString("o")").getTime();
        
        const btnFinalizar = document.getElementById("btn-finalizar");

        const CONTRACT_ADDRESS = "@Model.ContractAddress";
        const CONTRACT_ABI = await fetch('/abi/Contrato.json').then(r => r.json());

        const timerEl = document.getElementById("timer");
        const statusEl = document.getElementById("status");
        const outEl = document.getElementById("out");

        function show(msg) { statusEl.innerText = msg; }
        function log(o) { outEl.innerText = JSON.stringify(o, null, 2); }

    console.log(CONTRACT_ABI);
    console.log(CONTRACT_ADDRESS);

        // --- TEMPORIZADOR ---
        const interval = setInterval(() => {
            const now = Date.now();
            const diff = finVotacion - now;

                if (diff <= 0) {
                    timerEl.innerText = "⛔ Tiempo terminado";
                    clearInterval(interval);

                    document.getElementById("btn-op1").disabled = true;
                    document.getElementById("btn-op2").disabled = true;

                    // Redirigir automáticamente a "Finalizar votación"
                    btnFinalizar.disabled = false;

                    setTimeout(() => {
                        window.location.href = `/Juego/FinalizarVotacion?partidaId=${partidaId}&capituloId=${capituloId}`;
                    }, 1500);

                    return;
                }


            timerEl.innerText = Math.floor(diff / 1000) + " segundos";
        }, 500);

        // --- VOTAR ---
        async function ensureProvider() {
            if (!window.ethereum) {
                alert('MetaMask no detectado.');
                throw new Error('No MetaMask');
            }
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send('eth_requestAccounts', []);
            return provider;
        }

            async function vote(opcion) {
        try {
            const provider = await ensureProvider();
            const signer = provider.getSigner();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            show(`Votando opción ${opcion}...`);
            const tx = await contract.votar(partidaId, capituloId, opcion, { gasLimit: 300000 });

            show('Esperando confirmación...');
            await tx.wait();

            show("✅ Voto registrado en blockchain");
            btnFinalizar.disabled = false;  
        } catch (err) {
            console.error(err);
            show("❌ Error al votar");
        }
    }

        btnFinalizar.addEventListener("click", () => {
            window.location.href = `/Juego/FinalizarVotacion?partidaId=${partidaId}&capituloId=${capituloId}`;
        });

        const btnOp1 = document.getElementById("btn-op1");
        const btnOp2 = document.getElementById("btn-op2");

        btnOp1.addEventListener("click", () => vote(btnOp1.dataset.next));
        btnOp2.addEventListener("click", () => vote(btnOp2.dataset.next));


    })();
</script>

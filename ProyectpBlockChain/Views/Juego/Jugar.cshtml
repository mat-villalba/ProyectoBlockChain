@using ProyectoBlockChain.Logica.Core
@model InicioPartidaDTO
@{
    ViewData["Title"] = "Votar historia";
}

<h2>Votar historia</h2>

<p>Partida: <strong>@Model.PartidaId</strong> — Capítulo: <strong>@Model.Capitulo.Id</strong></p>

<p>Tiempo restante: <span id="timer" style="font-weight:bold;color:red"></span></p>

<div style="margin-top:20px;">
    <button id="btnA">Votar Opción A</button>
    <button id="btnB">Votar Opción B</button>
</div>

<p id="status" style="margin-top:12px;color:green"></p>
<pre id="out" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:8px;"></pre>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    (async () => {

        const partidaId = @Model.PartidaId;
        const capituloId = @Model.Capitulo.Id;
        const finVotacion = new Date("@Model.FinVotacion.ToString("o")").getTime();

        const CONTRACT_ADDRESS = "@Model.ContractAddress";
        const CONTRACT_ABI = await fetch('/abi/Contrato.json').then(r => r.json());

        const timerEl = document.getElementById("timer");
        const statusEl = document.getElementById("status");
        const outEl = document.getElementById("out");

        function show(msg) { statusEl.innerText = msg; }
        function log(o) { outEl.innerText = JSON.stringify(o, null, 2); }

        // --- TEMPORIZADOR ---
        const interval = setInterval(() => {
            const now = Date.now();
            const diff = finVotacion - now;

            if (diff <= 0) {
                timerEl.innerText = "⛔ Tiempo terminado";
                clearInterval(interval); // OPCIONAL pero prolijo
                return;
            }

            timerEl.innerText = Math.floor(diff / 1000) + " segundos";
        }, 500);

        // --- VOTAR ---
        async function ensureProvider() {
            if (!window.ethereum) {
                alert('MetaMask no detectado.');
                throw new Error('No MetaMask');
            }
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send('eth_requestAccounts', []);
            return provider;
        }

        async function vote(opcion) {
            try {
                const provider = await ensureProvider();
                const signer = provider.getSigner();
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                show(`Votando opción ${opcion}...`);
                const tx = await contract.votar(partidaId, capituloId, opcion, { gasLimit: 300000 });

                show('Esperando confirmación...');
                await tx.wait();

                show("✅ Voto registrado en blockchain");
            } catch (err) {
                console.error(err);
                show("❌ Error al votar");
            }
        }

        document.getElementById("btnA").addEventListener("click", () => vote("A"));
        document.getElementById("btnB").addEventListener("click", () => vote("B"));

    })();
</script>
